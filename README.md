# Сервис Forward Auth

Простой сервис forward-аутентификации, написанный на Go и предназначенный для использования с обратными прокси-серверами, такими как Caddy. Он предоставляет экран входа на основе PIN-кода для защиты ваших веб-приложений.

## Возможности

-   Аутентификация на основе PIN-кода (в настоящее время 4 цифры).
-   Сессии на основе Cookie.
-   Автоматическая отправка формы после ввода 4-й цифры PIN-кода.
-   Настраиваемый `AUTH_DOMAIN` для самого сервиса аутентификации.
-   Работает с директивой `forward_auth` в Caddy.
-   Стилизованные страницы входа и статуса.

## Требования

-   Go (рекомендуется версия 1.18+)
-   Caddy (или любой другой обратный прокси с поддержкой forward-аутентификации)

## Настройка

### 1. Сборка приложения

Склонируйте репозиторий (если применимо) или убедитесь, что у вас есть файл `main.go`. Соберите Go-приложение:

```bash
go build -o forward-auth
```

Это создаст исполняемый файл с именем `forward-auth`.

### 2. Конфигурация

Приложение настраивается с помощью переменных окружения:

-   `AUTH_PASSWORD`: 4-значный PIN-код для входа. По умолчанию `1234`.
-   `SESSION_SECRET`: Секретный ключ для подписи токенов сессии. Должен быть не менее 32 байт в длину. По умолчанию `secret-key-32-bytes-long-minimum`. **Настоятельно рекомендуется установить собственный надежный секрет в производственной среде.**
-   `AUTH_DOMAIN`: Полный URL-адрес, по которому будет размещен этот сервис аутентификации (например, `http://auth.example.com`). Используется для редиректов и установки правильного домена для cookie. По умолчанию `http://auth.zaitsv.dev`.
-   `PORT`: (Опционально) Порт, который будет слушать Go-приложение. По умолчанию `8080` (в настоящее время жестко прописан в `main.go` как `":8080"`). Если вы измените порт в `main.go`, соответствующим образом обновите конфигурацию прокси.

### 3. Конфигурация Caddyfile

Пример конфигурации `Caddyfile`:

```caddy
# Фрагмент для защищенных сайтов
(secure) {
    forward_auth forward-auth-service:8080 { # Указывает на ваше Go-приложение
        uri /  # Все проверки аутентификации идут в корень вашего Go-приложения
    }
}

# Домен для самого сервиса аутентификации
auth.example.com { # Замените на ваш AUTH_DOMAIN
    reverse_proxy forward-auth-service:8080 # Указывает на ваше Go-приложение
}

# Пример защищенного приложения
app1.example.com {
    # Обычные директивы вашего приложения (reverse_proxy и т.д.)
    reverse_proxy my-app1-service:3000 
    import secure
}

# Другое защищенное приложение
dashboard.example.com {
    respond "Это защищенная панель управления." # Или reverse_proxy и т.д.
    import secure
}
```

**Пояснение:**

-   Замените `forward-auth-service:8080` на фактический адрес/порт, где запущено ваше Go-приложение (например, `localhost:8080`, если запущено локально, или имя сервиса в среде Docker).
-   Установите `auth.example.com` в соответствии с вашей переменной окружения `AUTH_DOMAIN`.
-   Фрагмент `(secure)` определяет директиву `forward_auth`.
-   Защищенные приложения, такие как `app1.example.com` и `dashboard.example.com`, используют `import secure` для включения аутентификации.

### 4. Запуск сервиса

#### Напрямую:

Установите переменные окружения и запустите исполняемый файл:

```bash
export AUTH_PASSWORD="your-pin"
export SESSION_SECRET="your-super-strong-secret-key-min-32-bytes"
export AUTH_DOMAIN="http://auth.yourdomain.com"
./forward-auth
```

#### С Docker (Пример Dockerfile):

Создайте `Dockerfile`:

```dockerfile
# Этап 1: Сборка Go-приложения
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o forward-auth .

# Этап 2: Создание минимального образа
FROM alpine:latest
WORKDIR /app
COPY --from=builder /app/forward-auth /app/forward-auth

# Открываем порт (по умолчанию 8080)
EXPOSE 8080

# Установите переменные окружения здесь или через docker run/docker-compose
# ENV AUTH_PASSWORD="1234"
# ENV SESSION_SECRET="your-super-strong-secret-key-min-32-bytes"
# ENV AUTH_DOMAIN="http://localhost:8080" # Настройте для вашей конфигурации

ENTRYPOINT ["/app/forward-auth"]
```

Соберите и запустите Docker-образ:

```bash
docker build -t forward-auth-app .
docker run -p 8080:8080 \
    -e AUTH_PASSWORD="your-pin" \
    -e SESSION_SECRET="your-super-strong-secret-key-min-32-bytes" \
    -e AUTH_DOMAIN="http://localhost:8080" \
    forward-auth-app
```
(Настройте `AUTH_DOMAIN`, если Caddy и этот сервис доступны по-разному, например, через разные хостнеймы или порты в вашей Docker-конфигурации).

## Принцип Работы

1.  Когда пользователь пытается получить доступ к защищенному приложению (например, `app1.example.com`), директива `forward_auth` в Caddy отправляет подзапрос к Go-сервису `forward-auth` (на его корневой эндпоинт `/`).
2.  Go-сервис проверяет наличие действительного cookie `auth-token`.
3.  **Если токен действителен**: Go-сервис возвращает HTTP-статус `200 OK`. Caddy позволяет исходному запросу перейти к защищенному приложению.
4.  **Если токен недействителен или отсутствует**:
    a.  Go-сервис возвращает HTTP `302 Found`, перенаправляя браузер пользователя на `AUTH_DOMAIN` (например, `http://auth.example.com/`). URL перенаправления включает параметр `?redirect=`, содержащий исходный URL, к которому пользователь пытался получить доступ.
    b.  Пользователю отображается экран входа с PIN-кодом на `AUTH_DOMAIN`.
    c.  После ввода правильного PIN-кода Go-сервис устанавливает cookie `auth-token` (область действия которого распространяется на родительский домен `AUTH_DOMAIN` для SSO между поддоменами) и перенаправляет пользователя обратно на исходный `redirect` URL.
5.  Теперь пользователь может получить доступ к защищенному приложению.
6.  На `AUTH_DOMAIN` доступен эндпоинт `/logout` для очистки cookie сессии.

## Кастомизация

-   **Стилизация**: Измените HTML и CSS в функции `serveLoginPage` и в разделе страницы "Авторизован" в `comprehensiveRootHandler` в файле `main.go`.
-   **Длина PIN-кода**: В настоящее время пользовательский интерфейс стилизован для 4-значного PIN-кода (`maxlength="1"` на 4 полях ввода). Фактическая проверка пароля (`AUTH_PASSWORD`) — это просто сравнение строк. Чтобы изменить длину PIN-кода, вам потребуется:
    -   Изменить `AUTH_PASSWORD`.
    -   Изменить количество полей `<input type="text" class="pin-digit-input">` в `serveLoginPage`.
    -   Обновить массив `pinInputs` в JavaScript и связанную логику, если количество полей изменится.
-   **Порт**: Порт для прослушивания жестко задан как `":8080"` в `ListenAndServe`. При необходимости измените это в `main.go` и обновите конфигурацию прокси/Dockerfile.

## Вопросы Безопасности

-   **SESSION_SECRET**: Убедитесь, что это надежная, уникальная и случайно сгенерированная строка для производственных сред. Не используйте значение по умолчанию.
-   **HTTPS**: Всегда запускайте сервис аутентификации (`AUTH_DOMAIN`) и защищенные приложения через HTTPS в производственной среде. Caddy может автоматизировать это.
-   **Пароль/PIN**: Текущий PIN-код — это простой общий секрет. Для более высокой безопасности рассмотрите более надежные механизмы аутентификации.
-   **CSRF-защита**: Эндпоинт выхода (`/logout`) и форма входа в настоящее время не имеют CSRF-защиты. Это можно добавить для повышения безопасности.
-   **Обработка ошибок**: Обработка ошибок в Go-приложении является базовой.

